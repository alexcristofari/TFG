<!-- movies_index.html (Loop Infinito) -->
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Recomendador de Filmes</title>
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
    <style>
        :root { --theme-black: #000000; --theme-dark-gray: #1a1a1a; --theme-light-gray: #333; --theme-text-gray: #b3b3b3; --theme-white: #ffffff; --theme-primary: #E50914; }
        body { background-color: var(--theme-black ); color: var(--theme-white); font-family: 'Inter', sans-serif; margin: 0; padding-top: 120px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 2rem; }
        h1, h2 { font-weight: 700; }
        .main-header { position: fixed; top: 0; left: 0; width: 100%; text-align: center; padding: 1.5rem 0; z-index: 100; transition: background-color 0.3s ease, box-shadow 0.3s ease; background-color: transparent; }
        .main-header.scrolled { background-color: rgba(20, 20, 20, 0.9); backdrop-filter: blur(10px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4); }
        
        .main-header h1 { font-size: 2.2rem; color: var(--theme-primary); margin: 0 0 0.5rem 0; }
        .main-header p, p { color: var(--theme-text-gray); font-size: 1.1rem; margin: 0; }
        .discover-section h2 { font-size: 1.8rem; border-bottom: 1px solid var(--theme-light-gray); padding-bottom: 0.5rem; margin-bottom: 1.5rem; }

        .selection-grid { display: grid; grid-template-columns: 1fr 300px; gap: 1.5rem; align-items: start; margin-bottom: 2rem; }
        .profile-container { border: 1px solid var(--theme-light-gray); padding: 1.5rem; border-radius: 8px; display: flex; flex-direction: column; gap: 1rem; }
        .profile-container h2 { margin-top: 0; font-size: 1.2rem; } /* Tamanho padronizado */
        .selected-list { display: flex; flex-wrap: wrap; gap: 0.5rem; min-height: 24px; }
        .selected-item { background-color: var(--theme-light-gray); padding: 0.5rem 1rem; border-radius: 500px; font-size: 0.9rem; }
        .submit-container { display: flex; flex-direction: column; gap: 1rem; }
        #recommend-btn { background-color: var(--theme-primary); color: white; border: none; padding: 1rem 2rem; font-size: 1rem; border-radius: 4px; cursor: pointer; opacity: 0.5; transition: opacity 0.2s; width: 100%; }
        #recommend-btn:not(:disabled) { opacity: 1; }
        #genre-select { background-color: var(--theme-black); border: 1px solid var(--theme-light-gray); color: var(--theme-white); padding: 1rem; border-radius: 4px; font-size: 1rem; width: 100%; }
        .search-area { grid-column: 1 / -1; }
        .search-container { position: relative; }
        #search-input { width: 100%; background-color: var(--theme-black); border: 1px solid var(--theme-light-gray); color: white; padding: 1rem 1rem 1rem 3rem; font-size: 1rem; border-radius: 4px; box-sizing: border-box; }
        .search-container svg { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); width: 1.2rem; height: 1.2rem; fill: var(--theme-text-gray); }
        
        .results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(210px, 1fr)); gap: 1rem; }
        .search-result-card { background-color: var(--theme-dark-gray); border-radius: 4px; overflow: hidden; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .search-result-card.selected { border-color: var(--theme-primary); transform: scale(1.05); }
        .search-result-card img { width: 100%; display: block; aspect-ratio: 2/3; object-fit: cover; }
        .search-result-card-info { padding: 1rem; }
        .search-result-card-info strong { font-size: 1rem; }
        
        .discover-section { margin-top: 3rem; overflow: hidden; }
        .swiper-slide { width: 210px; }
        .swiper-button-next, .swiper-button-prev { color: var(--theme-primary); }
    </style>
</head>
<body>
    <header class="main-header" id="main-header"><h1>Recomendador de Filmes</h1><p>Escolha 3 ou mais filmes que você gosta e um gênero para explorar.</p></header>
    <div class="container">
        <form id="recommend-form" action="/movies/recommend" method="POST">
            <input type="hidden" name="movie_ids_json" id="movie_ids_json">
            <div class="selection-grid">
                <div class="profile-container"><h2>Seu Perfil de Filmes</h2><div id="selected-movies-list" class="selected-list"></div></div>
                <div class="submit-container">
                    <select name="genre_select" id="genre-select"><option value="">-- Escolha um Gênero (Opcional) --</option>{% for genre in genres %}<option value="{{ genre }}">{{ genre }}</option>{% endfor %}</select>
                    <button type="submit" id="recommend-btn" disabled>Gerar Recomendações</button>
                </div>
                <div class="search-area"><div class="search-container"><svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg><input type="text" id="search-input" placeholder="Busque por um filme para adicionar ao seu perfil..."></div></div>
            </div>
        </form>
        <div id="results-container"><!-- Os resultados da busca ou da descoberta aparecerão aqui --></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script>
        const header = document.getElementById('main-header' );
        window.addEventListener('scroll', () => { header.classList.toggle('scrolled', window.scrollY > 10); });

        // O resto do JavaScript continua o mesmo...
        const searchInput = document.getElementById('search-input');
        const resultsContainer = document.getElementById('results-container');
        const selectedList = document.getElementById('selected-movies-list');
        const recommendBtn = document.getElementById('recommend-btn');
        const hiddenInput = document.getElementById('movie_ids_json');
        let selectedMovies = new Map();
        function updateRecommendButton() { recommendBtn.disabled = selectedMovies.size < 3; }
        function renderSelectedMovies() {
            selectedList.innerHTML = '';
            selectedMovies.forEach(movie => {
                const item = document.createElement('div'); item.className = 'selected-item'; item.textContent = movie.title; selectedList.appendChild(item);
            });
            hiddenInput.value = JSON.stringify(Array.from(selectedMovies.keys()));
            updateRecommendButton();
        }
        function handleCardClick(movie, cardElement) {
            if (selectedMovies.has(movie.id)) { selectedMovies.delete(movie.id); cardElement.classList.remove('selected'); }
            else { selectedMovies.set(movie.id, movie); cardElement.classList.add('selected'); }
            renderSelectedMovies();
        }
        function createMovieCard(movie) {
            const card = document.createElement('div');
            card.className = 'search-result-card swiper-slide';
            if (selectedMovies.has(movie.id)) card.classList.add('selected');
            card.innerHTML = `<img src="${movie.poster_url}" alt="${movie.title}"><div class="search-result-card-info"><strong>${movie.title}</strong></div>`;
            card.addEventListener('click', () => handleCardClick(movie, card));
            return card;
        }
        async function showSearchResults(query) {
            const response = await fetch(`/movies/search?q=${encodeURIComponent(query)}`);
            const movies = await response.json();
            resultsContainer.innerHTML = '<div class="results-grid"></div>';
            const grid = resultsContainer.querySelector('.results-grid');
            movies.forEach(movie => grid.appendChild(createMovieCard(movie)));
        }
        async function showDiscoverResults() {
            const response = await fetch('/movies/discover');
            const data = await response.json();
            let html = '';
            if (data.popular_releases && data.popular_releases.length > 0) {
                html += `<div class="discover-section"><h2>Lançamentos Populares</h2><div class="swiper" id="swiper-popular"><div class="swiper-wrapper"></div><div class="swiper-button-prev"></div><div class="swiper-button-next"></div></div></div>`;
            }
            if (data.critically_acclaimed && data.critically_acclaimed.length > 0) {
                html += `<div class="discover-section"><h2>Aclamados pela Crítica</h2><div class="swiper" id="swiper-acclaimed"><div class="swiper-wrapper"></div><div class="swiper-button-prev"></div><div class="swiper-button-next"></div></div></div>`;
            }
            resultsContainer.innerHTML = html;
            
            data.popular_releases.forEach(movie => document.querySelector('#swiper-popular .swiper-wrapper').appendChild(createMovieCard(movie)));
            data.critically_acclaimed.forEach(movie => document.querySelector('#swiper-acclaimed .swiper-wrapper').appendChild(createMovieCard(movie)));
            
            const swiperOptions = {
                slidesPerView: 'auto',
                spaceBetween: 16,
                loop: true, // A MÁGICA DO LOOP INFINITO
                navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' },
                autoplay: {
                    delay: 4000,
                    disableOnInteraction: false,
                    pauseOnMouseEnter: true,
                },
            };
            new Swiper('#swiper-popular', { ...swiperOptions, navigation: { nextEl: '#swiper-popular .swiper-button-next', prevEl: '#swiper-popular .swiper-button-prev' } });
            new Swiper('#swiper-acclaimed', { ...swiperOptions, navigation: { nextEl: '#swiper-acclaimed .swiper-button-next', prevEl: '#swiper-acclaimed .swiper-button-prev' } });
        }
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value;
            if (query.length >= 3) { showSearchResults(query); }
            else if (query.length === 0) { showDiscoverResults(); }
        });
        document.addEventListener('DOMContentLoaded', showDiscoverResults);
        updateRecommendButton();
    </script>
</body>
</html>
