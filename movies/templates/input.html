<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Recomendação de Filmes - Entrada</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #0d0221 0%, #1a0b2e 50%, #16213e 100%);
            color: #e0e0e0;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
        }
        .card {
            background-color: #eeeef5ff;
            border: 1px solid #ff6b6b;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(247, 241, 241, 0.82);
        }
        .card-header {
            background: linear-gradient(90deg, #ff6b6b 0%, #ee5a6f 100%);
            color: #ffffff;
            font-weight: bold;
        }
        .btn-primary {
            background: linear-gradient(90deg, #ff6b6b 0%, #ee5a6f 100%);
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(90deg, #ee5a6f 0%, #ff6b6b 100%);
        }
        .btn-success {
            background: linear-gradient(90deg, #4ecca3 0%, #3bb78f 100%);
            border: none;
        }
        .btn-success:hover {
            background: linear-gradient(90deg, #3bb78f 0%, #4ecca3 100%);
        }
        .search-result {
            background-color: #cfd3e4ff;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .search-result:hover {
            background-color: #e1e3eeff;
        }
        .selected-movie {
            background-color: #edeef3ff;
            padding: 10px;
            margin: 5px;
            border-radius: 5px;
            display: inline-block;
            border: 1px solid #4ecca3;
        }
        .selected-movie .remove-btn {
            background-color: #ff6b6b;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 8px;
            margin-left: 10px;
            cursor: pointer;
        }
        #searchResults {
            max-height: 400px;
            overflow-y: auto;
        }
        .movie-poster-small {
            width: 50px;
            height: 75px;
            object-fit: cover;
            border-radius: 3px;
            margin-right: 10px;
        }
        .section-title {
            color: #ff6b6b;
            border-bottom: 2px solid #ff6b6b;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        /* Estilos para o painel de progresso */
        #progress-panel {
            display: none; /* Começa escondido */
            background-color: #16213e;
            color: #e0e0e0;
            border: 1px solid #ff6b6b;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        #progress-log {
            background-color: #0d0221;
            border: 1px solid #2a2d3a;
            border-radius: 5px;
            height: 200px;
            overflow-y: auto;
            padding: 10px;
            font-family: "Courier New", Courier, monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
        }
        .spinner-border {
            width: 1.5rem;
            height: 1.5rem;
            color: #ff6b6b;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <header class="text-center mb-4">
            <h1 class="display-4">Sistema de Recomendação de Filmes</h1>
            <p class="lead">Informe os filmes que você gostou para receber recomendações personalizadas</p>
        </header>
        
        <div class="card">
            <div class="card-header">
                <h3>Buscar Filmes</h3>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="movieSearch" class="form-label">Digite o nome de um filme que você gostou:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="movieSearch" placeholder="Ex: Matrix, Inception, Pulp Fiction...">
                        <button class="btn btn-primary" type="button" id="searchBtn">Buscar</button>
                    </div>
                </div>
                <div id="searchResults"></div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h3>Filmes Selecionados (<span id="selectedCount">0</span>)</h3>
            </div>
            <div class="card-body">
                <p class="text-muted">Selecione pelo menos 3 filmes para obter recomendações personalizadas.</p>
                <div id="selectedMovies"></div>
                <button class="btn btn-success btn-lg mt-3" id="generateBtn" disabled>Gerar Recomendações</button>
            </div>
        </div>

        <!-- Painel de Progresso (começa escondido) -->
        <div id="progress-panel">
            <div class="d-flex align-items-center mb-3">
                <div class="spinner-border me-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h4 class="mb-0">Gerando Recomendações...</h4>
            </div>
            <p class="text-muted">O sistema está analisando milhares de filmes para encontrar as melhores sugestões para você. Isso pode levar alguns minutos.</p>
            <div id="progress-log"></div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedMovies = [];
        
        document.getElementById("searchBtn").addEventListener("click", searchMovies);
        document.getElementById("movieSearch").addEventListener("keypress", function(e) {
            if (e.key === "Enter") {
                searchMovies();
            }
        });
        
        // A função generateRecommendations original foi renomeada para evitar conflito e a nova lógica de progresso foi adicionada
        document.getElementById("generateBtn").addEventListener("click", generateRecommendationsWithProgress);
        
        async function searchMovies() {
            const query = document.getElementById("movieSearch").value.trim();
            if (!query) {
                alert("Por favor, digite o nome de um filme.");
                return;
            }
            
            const resultsDiv = document.getElementById("searchResults");
            resultsDiv.innerHTML = "<p class=\"text-center\">Buscando...</p>";
            
            try {
                const response = await fetch(`/api/search?query=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    resultsDiv.innerHTML = "";
                    data.results.forEach(movie => {
                        const movieDiv = document.createElement("div");
                        movieDiv.className = "search-result d-flex align-items-center";
                        
                        const posterUrl = movie.poster_path 
                            ? `https://image.tmdb.org/t/p/w92${movie.poster_path}` 
                            : "https://via.placeholder.com/50x75?text=Sem+Poster";
                        
                        movieDiv.innerHTML = `
                            <img src="${posterUrl}" class="movie-poster-small" alt="${movie.title}">
                            <div>
                                <strong>${movie.title}</strong> (${movie.release_date ? movie.release_date.split("-")[0] : "N/A"})
                                <br>
                                <small class="text-muted">${movie.overview ? movie.overview.substring(0, 100) + "..." : "Sem sinopse"}</small>
                            </div>
                        `;
                        
                        movieDiv.addEventListener("click", () => addMovie(movie));
                        resultsDiv.appendChild(movieDiv);
                    });
                } else {
                    resultsDiv.innerHTML = "<p class=\"text-center text-muted\">Nenhum filme encontrado.</p>";
                }
            } catch (error) {
                console.error("Erro ao buscar filmes:", error);
                resultsDiv.innerHTML = "<p class=\"text-center text-danger\">Erro ao buscar filmes. Tente novamente.</p>";
            }
        }
        
        function addMovie(movie) {
            // Verifica se o filme já foi adicionado
            if (selectedMovies.find(m => m.id === movie.id)) {
                alert("Este filme já foi adicionado!");
                return;
            }
            
            selectedMovies.push(movie);
            updateSelectedMovies();
        }
        
        function removeMovie(movieId) {
            selectedMovies = selectedMovies.filter(m => m.id !== movieId);
            updateSelectedMovies();
        }
        
        function updateSelectedMovies() {
            const selectedDiv = document.getElementById("selectedMovies");
            const countSpan = document.getElementById("selectedCount");
            const generateBtn = document.getElementById("generateBtn");
            
            countSpan.textContent = selectedMovies.length;
            
            if (selectedMovies.length === 0) {
                selectedDiv.innerHTML = "<p class=\"text-muted\">Nenhum filme selecionado ainda.</p>";
                generateBtn.disabled = true;
            } else {
                selectedDiv.innerHTML = "";
                selectedMovies.forEach(movie => {
                    const movieDiv = document.createElement("div");
                    movieDiv.className = "selected-movie";
                    movieDiv.innerHTML = `
                        <strong>${movie.title}</strong> (${movie.release_date ? movie.release_date.split("-")[0] : "N/A"})
                        <button class="remove-btn" onclick="removeMovie(${movie.id})">✕</button>
                    `;
                    selectedDiv.appendChild(movieDiv);
                });
                
                generateBtn.disabled = selectedMovies.length < 3;
            }
        }
        
        // NOVA FUNÇÃO PARA GERAR RECOMENDAÇÕES COM FEEDBACK VISUAL
        async function generateRecommendationsWithProgress() {
            if (selectedMovies.length < 3) {
                alert("Por favor, selecione pelo menos 3 filmes.");
                return;
            }
            
            const generateBtn = document.getElementById("generateBtn");
            const progressPanel = document.getElementById("progress-panel");
            const progressLog = document.getElementById("progress-log");

            // Esconde os cards de seleção e mostra o painel de progresso
            document.querySelectorAll(".card").forEach(card => card.style.display = "none");
            generateBtn.disabled = true;
            progressPanel.style.display = "block";
            progressLog.innerHTML = "Iniciando conexão com o servidor...<br>";

            // Inicia a escuta por eventos de progresso (Server-Sent Events)
            const eventSource = new EventSource("/api/progress_stream");
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                progressLog.innerHTML += data.message + "<br>";
                // Auto-scroll para o final do log
                progressLog.scrollTop = progressLog.scrollHeight;
            };

            eventSource.onerror = function() {
                progressLog.innerHTML += "<span class=\"text-danger\">Conexão com o servidor perdida. Tentando reconectar...</span><br>";
            };

            try {
                const movieIds = selectedMovies.map(m => m.id);
                const response = await fetch("/api/generate_recommendations", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ movie_ids: movieIds })
                });
                
                eventSource.close();
                const data = await response.json();
                
                if (data.success) {
                    progressLog.innerHTML += "<strong>Redirecionando para os resultados!</strong>";
                    window.location.href = "/recommendations";
                } else {
                    progressLog.innerHTML += `<strong class=\"text-danger\">Erro: ${data.error || "Erro desconhecido"}</strong>`;
                    alert("Erro ao gerar recomendações: " + (data.error || "Erro desconhecido"));
                    // Mostra os cards novamente em caso de erro
                    document.querySelectorAll(".card").forEach(card => card.style.display = "block");
                    generateBtn.disabled = false;
                    progressPanel.style.display = "none";
                }
            } catch (error) {
                eventSource.close();
                console.error("Erro ao gerar recomendações:", error);
                progressLog.innerHTML += "<strong class=\"text-danger\">Erro de conexão. Tente novamente.</strong>";
                alert("Erro de conexão ao gerar recomendações. Tente novamente.");
                document.querySelectorAll(".card").forEach(card => card.style.display = "block");
                generateBtn.disabled = false;
                progressPanel.style.display = "none";
            }
        }
    </script>
</body>
</html>
